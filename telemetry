// Function to show the telemetry consent popup
function showTelemetryPopup() {
    const popup = document.getElementById('telemetry-popup');
    popup.style.display = 'flex';  // Show the popup
}

// Function to handle telemetry consent
async function handleTelemetryConsent(consent) {
    // Store the user's choice in local storage
    await chrome.storage.local.set({ telemetryConsent: consent });

    // Initialize analytics if consent is given
    if (consent) {
        initAnalytics();  // Initialize Google Analytics (or other analytics platforms)
    }

    // Hide the popup after the decision
    const popup = document.getElementById('telemetry-popup');
    popup.style.display = 'none';
}

// Function to get or create a unique ClientID
async function getOrCreateClientID() {
    // Get the stored ClientID from Chrome's local storage
    const result = await chrome.storage.local.get('ClientID');
    let ClientID = result.ClientID;
    
    // If ClientID doesn't exist, create one and store it
    if (!ClientID) {
        // Generate a new ClientID using crypto.randomUUID
        ClientID = crypto.randomUUID();
        // Store the new ClientID in Chrome's local storage
        await chrome.storage.local.set({ ClientID });
    }
    return ClientID;
}

// Initialize Google Analytics (or another analytics platform)
function initAnalytics() {
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXX'); // Replace with your actual Google Analytics Measurement ID
}

// Track custom events
function trackEvent(eventCategory, eventLabel, value) {
    gtag('event', eventCategory, {
        'eventCategory': eventCategory,
        'eventLabel': eventLabel,
        'value': value
    });
}

// Function to track the state of all checkboxes
function trackCheckboxStates() {
    // Select all checkbox inputs
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');

    // Iterate through each checkbox and track its state
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkboxId = checkbox.id;  // Get the checkbox ID
            const checkboxState = checkbox.checked ? 'ON' : 'OFF'; // State of the checkbox

            // Log the state (you can replace this with your actual analytics call)
            console.log(`Checkbox ${checkboxId} is ${checkboxState}`);

            // Track the checkbox toggle event
            trackEvent('Weda-Helper Options', checkboxId, checkboxState === 'ON' ? 1 : 0);
        });
    });
}

// Call the function to initialize checkbox tracking when the page is loaded
document.addEventListener('DOMContentLoaded', function() {
    trackCheckboxStates();

    // Check if telemetry consent is already set
    chrome.storage.local.get('telemetryConsent', (result) => {
        if (result.telemetryConsent === undefined) {
            // Show the popup if consent hasn't been given yet
            showTelemetryPopup();
        } else {
            // Initialize analytics if consent was already given
            if (result.telemetryConsent) {
                initAnalytics();
            }
        }
    });

    // Add event listeners to buttons in the popup
    document.getElementById('allow-telemetry').addEventListener('click', () => handleTelemetryConsent(true));
    document.getElementById('deny-telemetry').addEventListener('click', () => handleTelemetryConsent(false));
});

// Expose trackEvent globally
window.trackEvent = trackEvent;
